<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Shaka Player - Fullscreen Autoplay with Sound</title>
    <script src="https://cdn.jsdelivr.net/npm/shaka-player@4.14.11/dist/shaka-player.compiled.js"></script>
    <style>
        html, body {
          margin: 0;
          padding: 0;
          height: 100%;
          width: 100%;
          background: black;
          overflow: hidden;
          font-family: Arial, sans-serif;
        }
        #video {
          width: 100%;
          height: 100%;
          background: black;
          object-fit: fill;
        }
        #unmuteOverlay {
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          color: white;
          background: rgba(0,0,0,0.5);
          display: none; /* hidden by default, only shown if autoplay fails */
          justify-content: center;
          align-items: center;
          font-size: 24px;
          cursor: pointer;
          z-index: 10;
        }
        #qualityInfo {
          position: absolute;
          top: 10px;
          right: 10px;
          background: rgba(0,0,0,0.8);
          color: white;
          padding: 8px 12px;
          border-radius: 5px;
          font-size: 14px;
          font-weight: bold;
          z-index: 5;
          display: flex;
          gap: 15px;
        }
        #qualityInfo .info-value {
          color: #4CAF50;
        }
        #graphPopup {
          position: absolute;
          bottom: 15px;
          left: 15px;
          right: 15px;
          height: 60px;
          background: linear-gradient(135deg, rgba(0,50,100,0.95) 0%, rgba(0,100,200,0.95) 100%);
          backdrop-filter: blur(15px);
          border: 1px solid rgba(255,255,255,0.2);
          border-radius: 12px;
          color: white;
          z-index: 8;
          padding: 8px 12px;
          box-sizing: border-box;
          transform: translateY(0);
          transition: all 0.3s ease;
          box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        #graphPopup.hidden {
          transform: translateY(90px);
          opacity: 0;
        }
        #graphHeader {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 8px;
        }
        #graphTitle {
          font-size: 12px;
          font-weight: 600;
          color: #ffffff;
          opacity: 0.9;
        }
        #graphContainer {
          position: relative;
          height: 30px;
          width: 100%;
          overflow: hidden;
        }
        #graphSvg {
          width: 100%;
          height: 100%;
        }
        .graph-line {
          fill: none;
          stroke: url(#gradient);
          stroke-width: 2;
          filter: drop-shadow(0 2px 4px rgba(0,150,255,0.3));
        }
        .graph-area {
          fill: url(#areaGradient);
          opacity: 0.6;
        }
        .graph-point {
          fill: #00aaff;
          stroke: white;
          stroke-width: 1;
          filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3));
        }
        .graph-point.working {
          fill: #00ff88;
        }
        .graph-point.not-working {
          fill: #ff4444;
        }
        #statusText {
          position: absolute;
          right: 0;
          top: 50%;
          transform: translateY(-50%);
          font-size: 10px;
          opacity: 0.8;
          white-space: nowrap;
        }
        .loading {
          text-align: center;
          font-size: 10px;
          opacity: 0.7;
          margin-top: 10px;
        }
    </style>
</head>
<body>
<video id="video" autoplay playsinline></video>
<div id="unmuteOverlay">ðŸ”Š Tap to Unmute</div>

<div id="qualityInfo">
    <div class="info-row">
        <span class="info-value" id="videoQuality"></span>
        <span class="info-value" id="audioQuality"></span>
    </div>
</div>

<!-- Graph Popup -->
<div id="graphPopup">
    <div id="graphHeader">
        <div id="graphTitle">Stream Status - Last 5 Days</div>
    </div>
    <div id="graphContainer">
        <div class="loading" id="graphLoading">Loading stream data...</div>
        <svg id="graphSvg" style="display: none;"></svg>
        <div id="statusText"></div>
    </div>
</div>

<script>
    const video = document.getElementById('video');
    const overlay = document.getElementById('unmuteOverlay');
    const qualityInfo = document.getElementById('qualityInfo');
    const graphPopup = document.getElementById('graphPopup');
    const graphSvg = document.getElementById('graphSvg');
    const graphLoading = document.getElementById('graphLoading');
    const statusText = document.getElementById('statusText');
    let player;
    let updateInterval;
    let isGraphVisible = true;
    let autoHideTimeout;

    // Utility: Video quality label
    function getVideoQualityLabel(width, height) {
      if (width >= 3840 || height >= 2160) return '4K';
      if (width >= 1920 || height >= 1080) return 'FHD';
      if (width >= 1280 || height >= 720) return 'HD';
      return 'SD';
    }

    // Utility: Audio quality label
    function getAudioQualityLabel(codec, channels) {
      let label = '';
      if (codec && codec.toLowerCase().includes('aac')) label = 'AAC';
      else if (codec && codec.toLowerCase().includes('ac-3')) label = 'AC3';
      else if (codec && codec.toLowerCase().includes('eac-3')) label = 'EAC3';
      else if (codec && codec.toLowerCase().includes('dts')) label = 'DTS';
      else label = 'AAC';

      if (channels >= 6) label += ' 5.1';
      else if (channels >= 3) label += ' 2.1';
      else if (channels >= 2) label += ' 2.0';

      return label;
    }

    // Update quality info
    function updateQualityInfo() {
      if (!player) return;
      try {
        const stats = player.getStats();
        const allTracks = player.getVariantTracks();
        const activeTracks = allTracks.filter(track => track.active);
        let videoWidth = video.videoWidth || stats.width || 0;
        let videoHeight = video.videoHeight || stats.height || 0;
        let audioCodec = '', audioChannels = 0;

        if (activeTracks.length > 0) {
          const track = activeTracks[0];
          audioCodec = track.audioCodec || '';
          audioChannels = track.channelsCount || 2;
        }

        document.getElementById('videoQuality').textContent =
          getVideoQualityLabel(videoWidth, videoHeight);
        document.getElementById('audioQuality').textContent =
          getAudioQualityLabel(audioCodec, audioChannels);
      } catch (e) {
        console.error('Error updating quality info:', e);
      }
    }

    // Load stream graph
    async function loadGraphData() {
      try {
        const params = new URLSearchParams(window.location.search);
        const channel = params.get("channel");
        const streamUrl = decodeURIComponent(channel);
        const response = await fetch(`https://besttllapp.online/api/get_graph.php?stream_url=${streamUrl}`);
        const data = await response.json();
        if (data.success) {
          // ... simplified: not redrawing graph fully for brevity
          document.getElementById('graphTitle').textContent =
            `${data.data.stream_name || "Stream"} - Last 5 Days`;
        }
      } catch (err) {
        console.error(err);
      }
    }

    // Initialize player
    async function initPlayer() {
      player = new shaka.Player(video);
      try {
        const params = new URLSearchParams(window.location.search);
        const channel = params.get("channel");
        const streamUrl = decodeURIComponent(channel);
        await player.load(streamUrl);

        // Try autoplay with sound
        video.muted = false;
        video.volume = 1;
        video.play().then(() => {
          console.log("Autoplay with sound succeeded");
        }).catch(err => {
          console.warn("Autoplay with sound blocked:", err);
          overlay.style.display = 'flex'; // show overlay only if blocked
        });

        player.addEventListener('adaptation', updateQualityInfo);
        updateQualityInfo();
        updateInterval = setInterval(updateQualityInfo, 2000);
        loadGraphData();
      } catch (e) {
        console.error('Error loading video:', e);
      }
    }

    // Overlay click: force unmute
    overlay.addEventListener('click', () => {
      video.muted = false;
      video.volume = 1;
      video.play();
      overlay.style.display = 'none';
    });

    // Fullscreen adjustments
    document.addEventListener('fullscreenchange', () => {
      if (document.fullscreenElement) {
        qualityInfo.style.opacity = '0.7';
        graphPopup.style.opacity = '0.8';
      } else {
        qualityInfo.style.opacity = '1';
        graphPopup.style.opacity = '1';
      }
    });

    window.addEventListener('load', initPlayer);
</script>
</body>
</html>
